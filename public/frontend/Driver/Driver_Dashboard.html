<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CaneMap - Driver Dashboard</title>

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="../../css/output.css" />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- SweetAlert2 for modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

    <!-- Leaflet CSS and JS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      :root {
        --cane-50: #f7fee7;
        --cane-100: #ecfcca;
        --cane-200: #d8f999;
        --cane-300: #bbf451;
        --cane-400: #9ae600;
        --cane-500: #7ccf00;
        --cane-600: #5ea500;
        --cane-700: #497d00;
        --cane-800: #3c6300;
        --cane-900: #35530e;
        --cane-950: #192e03;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--cane-500), var(--cane-600));
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, var(--cane-600), var(--cane-700));
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(94, 165, 0, 0.3);
      }

      .btn-secondary {
        background: linear-gradient(135deg, var(--cane-200), var(--cane-300));
        color: var(--cane-800);
        transition: all 0.3s ease;
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, var(--cane-300), var(--cane-400));
        transform: translateY(-1px);
      }

      .section-card {
        background: linear-gradient(135deg, white, var(--cane-50));
        border: 1px solid var(--cane-200);
        transition: all 0.3s ease;
      }

      .section-card:hover {
        box-shadow: 0 8px 25px rgba(94, 165, 0, 0.15);
        transform: translateY(-2px);
      }

      .badge-indicator {
        background: linear-gradient(135deg, var(--cane-400), var(--cane-500));
        color: white;
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 600;
      }

      .driver-feature {
        border-left: 4px solid var(--cane-500);
        background: linear-gradient(135deg, var(--cane-50), white);
      }

      /* Sidebar transitions */
      .sidebar-transition {
        transition: transform 0.3s ease-in-out;
      }

      /* Mobile sidebar overlay */
      .sidebar-overlay {
        transition: opacity 0.3s ease-in-out;
      }

      /* Desktop collapsed sidebar */
      @media (min-width: 1024px) {
        body.sidebar-collapsed #sidebar {
          width: 5rem;
        }
        body.sidebar-collapsed #sidebar .nav-item span {
          opacity: 0;
          width: 0;
          overflow: hidden;
          display: none;
        }
        body.sidebar-collapsed #sidebar .nav-item {
          justify-content: center;
          padding-left: 0.75rem;
          padding-right: 0.75rem;
        }
        body.sidebar-collapsed #sidebar .nav-item i {
          margin: 0;
        }
        body.sidebar-collapsed #sidebar #sidebarUserName,
        body.sidebar-collapsed #sidebar #sidebarUserType {
          display: none;
        }
        body.sidebar-collapsed #sidebar .flex.items-center.space-x-3 > div:not(:first-child) {
          display: none;
        }
        body.sidebar-collapsed #sidebar .space-x-3 {
          gap: 0;
        }
      }

      /* Ensure content/header shift with sidebar state on desktop */
      @media (min-width: 1024px) {
        body:not(.sidebar-collapsed) #driverMainWrapper {
          margin-left: 16rem !important;
        }
        body.sidebar-collapsed #driverMainWrapper {
          margin-left: 5rem !important;
        }
        body:not(.sidebar-collapsed) #driverHeaderContainer {
          padding-left: 16rem !important;
        }
        body.sidebar-collapsed #driverHeaderContainer {
          padding-left: 5rem !important;
        }
      }

      /* FullCalendar customization */
      .fc {
        font-family: inherit;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        font-size: 0.875rem;
      }
      .fc {
        height: auto !important;
      }
      .fc .fc-scroller {
        overflow: visible !important;
      }

      .fc-toolbar {
        background: linear-gradient(135deg, var(--cane-50), white);
        border-bottom: 1px solid var(--cane-200);
        padding: 0.5rem;
      }

      .fc-toolbar-title {
        color: var(--cane-800);
        font-weight: 600;
        font-size: 1rem;
      }

      .fc-button-primary {
        background: linear-gradient(
          135deg,
          var(--cane-500),
          var(--cane-600)
        ) !important;
        border: none !important;
        border-radius: 0.375rem !important;
        padding: 0.25rem 0.5rem !important;
        font-weight: 500 !important;
        font-size: 0.75rem !important;
        box-shadow: 0 1px 2px rgba(94, 165, 0, 0.2) !important;
        transition: all 0.3s ease !important;
        min-height: auto !important;
        line-height: 1.2 !important;
      }

      .fc-button-primary:hover {
        background: linear-gradient(
          135deg,
          var(--cane-600),
          var(--cane-700)
        ) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 8px rgba(94, 165, 0, 0.3) !important;
      }

      .task-filter-btn {
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
      }

      .task-filter-btn:hover {
        background: #e2e8f0;
        color: #475569;
      }

      .task-filter-btn.active {
        background: var(--cane-600);
        color: white;
        border-color: var(--cane-600);
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header
      class="shadow-lg bg-white relative z-30"
    >
      <div
        id="driverHeaderContainer"
        class="container mx-auto px-6 py-3 lg:pl-64"
      >
          <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <!-- Hamburger (header, left) -->
            <button id="hamburgerBtn" class="lg:hidden text-gray-800 hover:text-cane-600 transition-colors hamburger-icon p-3 -ml-2" onclick="toggleSidebar()" aria-label="Toggle menu">
              <i class="fas fa-bars text-xl"></i>
            </button>
          </div>
          <div class="text-center">
            <div class="flex items-center justify-center space-x-2">
              <span id="badgeIndicator" class="badge-indicator hidden"
                >Driver Badge</span
              >
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <!-- (hamburger moved to header left) -->

            <!-- Back to Lobby Button -->
            <a
              href="../Common/lobby.html"
              class="flex items-center space-x-2 text-gray-700 hover:text-cane-600 transition-colors px-3 py-2 rounded-lg hover:bg-cane-50"
              title="Back to Lobby"
            >
              <i class="fas fa-home text-lg"></i>
              <span class="hidden md:inline text-sm font-medium">Lobby</span>
            </a>

            <!-- Open a Rental (Driver) -->
            <button id="btnDriverRental" class="hidden flex items-center space-x-2 text-gray-700 hover:text-cane-600 transition-colors px-3 py-2 rounded-lg hover:bg-cane-50" title="Open a Rental">
              <i class="fas fa-truck-moving"></i>
              <span class="hidden sm:inline text-sm font-medium">Open a Rental</span>
            </button>

            <!-- Notification Bell -->
            <div class="relative">
              <button
                id="notificationBtn"
                class="text-gray-700 hover:text-cane-600 transition-colors relative"
              >
                <i class="fas fa-bell text-lg"></i>
                <span
                  id="notificationCount"
                  class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden"
                  >0</span
                >
              </button>

              <!-- Notification Dropdown -->
              <div
                id="notificationDropdown"
                class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-[var(--cane-200)] z-50 max-h-96 overflow-y-auto"
              >
                <div
                  class="p-3 border-b border-gray-200 flex items-center justify-between"
                >
                  <h3 class="font-semibold text-gray-900">Notifications</h3>
                  <button
                    id="refreshNotifications"
                    class="text-[var(--cane-600)] hover:text-[var(--cane-700)]"
                  >
                    <i class="fas fa-sync-alt text-sm"></i>
                  </button>
                </div>
                <div id="notificationsList" class="divide-y divide-gray-100">
                  <!-- Notifications will be loaded here -->
                </div>
              </div>
            </div>

            <!-- Profile Dropdown -->
            <div class="relative">
              <button
                id="profileDropdownBtn"
                class="flex items-center space-x-2 text-gray-700 hover:text-cane-600 transition-all duration-300"
              >
                <div
                  class="w-8 h-8 bg-gradient-to-br from-[var(--cane-400)] to-[var(--cane-500)] rounded-full flex items-center justify-center shadow-md border border-white/30"
                >
                  <i class="fas fa-user text-white text-sm"></i>
                </div>
                <span class="font-medium uppercase tracking-wider text-sm" id="userName">Driver</span>
                <i
                  class="fas fa-chevron-down text-white text-xs transition-transform duration-300"
                ></i>
              </button>

              <div
                id="profileDropdown"
                class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-[var(--cane-200)] opacity-0 invisible transition-all duration-300 transform scale-95 origin-top-right z-50"
              >
                <div class="py-2">
                  <div class="px-4 py-3 border-b border-[var(--cane-100)]">
                    <p
                      class="text-sm font-medium text-[var(--cane-900)]"
                      id="dropdownUserName"
                    >
                      Driver
                    </p>
                    <p
                      class="text-xs text-[var(--cane-600)]"
                      id="dropdownUserType"
                    >
                      Driver
                    </p>
                  </div>
                  <a
                    href="../Common/profile-settings.html"
                    class="flex items-center px-4 py-2 text-sm text-[var(--cane-700)] hover:bg-[var(--cane-50)] transition-colors"
                  >
                    <i class="fas fa-user-edit mr-3 text-[var(--cane-500)]"></i>
                    Profile Information
                  </a>
                  <div class="border-t border-[var(--cane-100)] mt-2">
                    <button
                      id="driverLogoutBtn"
                      onclick="logout()"
                      class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors"
                    >
                      <i class="fas fa-sign-out-alt mr-3"></i>
                      Logout
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content with Sidebar -->
    <div id="driverMainWrapper" class="flex relative lg:ml-64">
      <!-- Mobile Sidebar Overlay -->
      <div
        id="sidebarOverlay"
        class="sidebar-overlay fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"
        style="z-index: 45;"
      ></div>

      <!-- Left Sidebar -->
      <aside
        id="sidebar"
        class="fixed left-0 top-0 h-full w-64 shadow-lg transform -translate-x-full lg:translate-x-0 z-50 transition-all duration-300 ease-in-out flex flex-col"
        style="background: linear-gradient(180deg, var(--cane-700) 0%, var(--cane-600) 100%);"
      >
        <div class="p-6">
          <!-- Close button for mobile -->
          <div class="flex justify-between items-center mb-4">
            <!-- Desktop collapse button -->
            <button
              id="collapseSidebarBtn"
              class="hidden lg:inline-flex items-center justify-center text-gray-300 hover:text-white p-2 rounded"
              title="Collapse sidebar"
              onclick="toggleSidebarCollapse()"
            >
              <i class="fas fa-bars"></i>
            </button>
            <!-- Close button for mobile -->
            <div class="lg:hidden">
              <button
                id="closeSidebarBtn"
                class="text-gray-400 hover:text-white"
              >
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
          </div>

          <!-- Driver Profile (compact) -->
          <div class="flex items-center space-x-3 mb-5">
            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
              <i class="fas fa-user text-white text-xl"></i>
            </div>
            <div class="text-left">
              <p class="text-sm font-medium text-white uppercase tracking-wider" id="sidebarUserName">Driver</p>
              <p class="text-xs text-white/80" id="sidebarUserType">Driver</p>
            </div>
          </div>
          <div class="border-b border-gray-700 mb-4"></div>

          <!-- Navigation Menu -->
          <nav class="space-y-2">
            <!-- Dashboard -->
            <a href="#" class="nav-item flex items-center gap-3 p-3 text-white/90 hover:bg-white/10 rounded-lg transition-all duration-200" data-section="dashboard">
              <i class="fas fa-gauge-high w-5 h-5"></i>
              <span>Dashboard</span>
            </a>
            <p class="text-xs font-medium text-white/70 uppercase tracking-wider px-4 pt-1 pb-2">Overview</p>

            <!-- My Fields -->
            <a
              href="#"
              class="nav-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors"
              data-section="my-fields"
            >
              <i class="fas fa-map-marked-alt w-5 h-5"></i>
              <span>My Fields</span>
            </a>

            <!-- My Tasks -->
            <a
              href="#"
              class="nav-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors"
              data-section="my-tasks"
            >
              <i class="fas fa-clipboard-check w-5 h-5"></i>
              <span>My Tasks</span>
            </a>

            <!-- Transport/Rentals -->
            <a
              href="#"
              class="nav-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors"
              data-section="transport"
            >
              <i class="fas fa-truck-fast w-5 h-5"></i>
              <span>Transport</span>
            </a>
          </nav>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main id="mainContent" class="w-full px-4 py-8 lg:px-8">
        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section">
          <div class="-mt-2">
            <h2 class="text-3xl font-bold text-[var(--cane-950)] -mb-1">Driver Dashboard</h2>
            <div>
              <p class="text-[var(--cane-700)] text-sm -mt-1">Overview of your tasks, rentals, and transport assignments</p>
              <div style="height: 1px; background: var(--cane-400); margin: 0.25rem 0 1.5rem 0; opacity: 0.7;"></div>
            </div>
          </div>

          <!-- Dashboard Stats -->
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
          >
            <div class="section-card rounded-xl p-6 hover:shadow-md transition">
              <div class="flex items-center gap-4">
                <div
                  class="w-14 h-14 bg-gradient-to-br from-[var(--cane-500)] to-[var(--cane-600)] rounded-xl flex items-center justify-center flex-shrink-0"
                >
                  <i class="fas fa-map-marker-alt text-white text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-[var(--cane-600)] mb-1">
                    Active Fields
                  </p>
                  <p
                    class="text-3xl font-bold text-[var(--cane-900)]"
                    id="activeFieldsCount"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>

            <div class="section-card rounded-xl p-6 hover:shadow-md transition">
              <div class="flex items-center gap-4">
                <div
                  class="w-14 h-14 bg-gradient-to-br from-[var(--cane-400)] to-[var(--cane-500)] rounded-xl flex items-center justify-center flex-shrink-0"
                >
                  <i class="fas fa-clipboard-list text-white text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-[var(--cane-600)] mb-1">
                    Total Tasks
                  </p>
                  <p
                    class="text-3xl font-bold text-[var(--cane-900)]"
                    id="totalTasksCount"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>

            <div class="section-card rounded-xl p-6 hover:shadow-md transition">
              <div class="flex items-center gap-4">
                <div
                  class="w-14 h-14 bg-gradient-to-br from-amber-400 to-amber-500 rounded-xl flex items-center justify-center flex-shrink-0"
                >
                  <i class="fas fa-clock text-white text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-600 mb-1">
                    Pending Tasks
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900"
                    id="pendingTasksCount"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>

            <div class="section-card rounded-xl p-6 hover:shadow-md transition">
              <div class="flex items-center gap-4">
                <div
                  class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0"
                >
                  <i class="fas fa-truck text-white text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-600 mb-1">
                    Pending Rentals
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900"
                    id="pendingRentalsCount"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity Section -->
          <div class="section-card rounded-xl p-6 hover:shadow-md transition">
            <h3
              class="text-lg font-bold text-[var(--cane-900)] mb-4 flex items-center gap-2"
            >
              <i class="fas fa-bolt text-[var(--cane-600)]"></i>
              Recent Activity
            </h3>
            <ul
              id="recentActivityList"
              class="divide-y divide-gray-200 text-sm"
            >
              <li class="py-3 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                Loading recent activity...
              </li>
            </ul>
          </div>
        </div>

        <!-- My Tasks Section -->
        <div id="my-tasks" class="content-section hidden">
          <div class="section-card rounded-xl p-6 shadow-sm">
            <div
              class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4"
            >
              <div>
                <h2 class="text-2xl font-bold text-[var(--cane-950)]">
                  My Tasks
                </h2>
                <p class="text-[var(--cane-700)] text-sm mt-1">
                  Tasks assigned to you across all fields
                </p>
              </div>
              <button
                id="createWorkLogBtn"
                onclick="openDriverLogWorkModal()"
                class="px-6 py-3 bg-gradient-to-r from-[var(--cane-600)] to-[var(--cane-700)] hover:from-[var(--cane-700)] hover:to-[var(--cane-800)] text-white rounded-xl font-semibold transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
              >
                <i class="fas fa-plus mr-2"></i>Log Work
              </button>
            </div>

            <!-- Task Filters -->
            <div class="flex gap-2 mb-4">
              <button
                class="task-filter-btn active px-4 py-2 rounded-lg text-sm font-medium"
                data-filter="all"
              >
                All Tasks
              </button>
              <button
                class="task-filter-btn px-4 py-2 rounded-lg text-sm font-medium"
                data-filter="pending"
              >
                Pending
              </button>
              <button
                class="task-filter-btn px-4 py-2 rounded-lg text-sm font-medium"
                data-filter="done"
              >
                Completed
              </button>
            </div>

            <div id="myTasksList" class="space-y-3">
              <div class="text-center py-8">
                <i
                  class="fas fa-spinner fa-spin text-[var(--cane-500)] text-2xl mb-3"
                ></i>
                <p class="text-[var(--cane-600)]">Loading your tasks...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- My Fields Section -->
        <div id="my-fields" class="content-section hidden">
          <div class="section-card rounded-xl p-6 shadow-sm">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-[var(--cane-950)]">
                My Fields
              </h2>
              <p class="text-[var(--cane-700)] text-sm mt-1">
                Fields where you are actively assigned
              </p>
            </div>
            <div id="myFieldsList" class="space-y-3">
              <div class="text-center py-8">
                <i
                  class="fas fa-spinner fa-spin text-[var(--cane-500)] text-2xl mb-3"
                ></i>
                <p class="text-[var(--cane-600)]">Loading your fields...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Transport Section -->
        <div id="transport" class="content-section hidden">
          <div class="section-card rounded-xl p-6 shadow-sm">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-[var(--cane-950)]">
                Transport & Rentals
              </h2>
              <p class="text-[var(--cane-700)] text-sm mt-1">
                Manage your driver rental requests and transport assignments
              </p>
            </div>

            <!-- Rental Requests List -->
            <div id="rentalRequestsList" class="space-y-3">
              <div class="flex items-center justify-center py-12 text-gray-500">
                <i class="fas fa-spinner fa-spin text-3xl"></i>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Driver Dashboard JavaScript -->
    <script type="module" src="../../backend/Common/activity-logger.js"></script>
    <script
      type="module"
      src="../../backend/Driver/Driver_Dashboard.js"
    ></script>
    <script type="module" src="../../backend/Driver/driver-ui.js"></script>
    <script type="module" src="../../backend/Driver/driver-init.js"></script>

    <script>
      // SPA-style section switcher
      function showSection(sectionId) {
        document
          .querySelectorAll(".content-section")
          .forEach((s) => s.classList.add("hidden"));
        const el = document.getElementById(sectionId);
        if (el) el.classList.remove("hidden");

        // Active nav styling
        document.querySelectorAll(".nav-item").forEach((a) => {
          a.classList.remove("text-white", "bg-gray-800");
          a.classList.add("text-gray-300");
        });
        const active = document.querySelector(
          `.nav-item[data-section="${sectionId}"]`
        );
        if (active) {
          active.classList.remove("text-gray-300");
          active.classList.add("text-white", "bg-gray-800");
        }
      }

      // Handle main nav items
      document.querySelectorAll(".nav-item").forEach((a) => {
        a.addEventListener("click", (e) => {
          const section = a.getAttribute("data-section");
          if (section) {
            e.preventDefault();
            showSection(section);
          }
          // Close mobile sidebar if open
          const sidebar = document.getElementById("sidebar");
          const overlay = document.getElementById("sidebarOverlay");
          if (sidebar && overlay) {
            sidebar.classList.add("-translate-x-full");
            overlay.classList.add("hidden");
          }
        });
      });

      // Hamburger menu
      const hamburgerBtn = document.getElementById("hamburgerBtn");
      if (hamburgerBtn) {
        hamburgerBtn.addEventListener("click", () => {
          const sidebar = document.getElementById("sidebar");
          const overlay = document.getElementById("sidebarOverlay");
          if (sidebar && overlay) {
            sidebar.classList.remove("-translate-x-full");
            overlay.classList.remove("hidden");
          }
        });
      }

      // Close sidebar (mobile)
      const closeSidebarBtn = document.getElementById("closeSidebarBtn");
      if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener("click", () => {
          const sidebar = document.getElementById("sidebar");
          const overlay = document.getElementById("sidebarOverlay");
          if (sidebar && overlay) {
            sidebar.classList.add("-translate-x-full");
            overlay.classList.add("hidden");
          }
        });
      }

      // Sidebar overlay click
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener("click", () => {
          const sidebar = document.getElementById("sidebar");
          sidebar.classList.add("-translate-x-full");
          sidebarOverlay.classList.add("hidden");
        });
      }

      // Collapse sidebar (desktop)
      const collapseSidebarBtn = document.getElementById("collapseSidebarBtn");
      if (collapseSidebarBtn) {
        collapseSidebarBtn.addEventListener("click", () => {
          document.body.classList.toggle("sidebar-collapsed");
        });
      }

      // Task filter buttons
      document.querySelectorAll(".task-filter-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".task-filter-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const filter = btn.getAttribute("data-filter");
          // Filter logic will be handled by driver-ui.js
          if (window.filterDriverTasks) {
            window.filterDriverTasks(filter);
          }
        });
      });
    </script>

    <script>
      // Driver rental header button: try to use shared lobby helpers if available,
      // otherwise create a simple iframe overlay fallback.
      (function(){
        function createFallbackOverlay(){
          let wrapper = document.getElementById('driverRentalModalWrapper');
          if (!wrapper){
            wrapper = document.createElement('div');
            wrapper.id = 'driverRentalModalWrapper';
            wrapper.style.position = 'fixed';
            wrapper.style.inset = '0';
            wrapper.style.background = 'rgba(0,0,0,0.45)';
            wrapper.style.zIndex = '60';
            wrapper.style.display = 'flex';
            wrapper.style.alignItems = 'center';
            wrapper.style.justifyContent = 'center';
            const frame = document.createElement('iframe');
            frame.id = 'driverRentalFrame';
            frame.src = '../Driver/Driver_Rental.html';
            frame.style.width = '980px';
            frame.style.height = '640px';
            frame.style.border = '0';
            frame.style.borderRadius = '8px';
            frame.style.boxShadow = '0 12px 40px rgba(0,0,0,0.5)';
            wrapper.appendChild(frame);
            wrapper.addEventListener('click', function(e){ if (e.target === wrapper) wrapper.remove(); });
            document.body.appendChild(wrapper);
          }
          return wrapper;
        }

        function openFallback(){ createFallbackOverlay(); }
        function closeFallback(){ const w = document.getElementById('driverRentalModalWrapper'); if (w) w.remove(); }

        document.addEventListener('DOMContentLoaded', function(){
          const btn = document.getElementById('btnDriverRental');
          if (!btn) return;

          // Show button for drivers (best-effort). If you want it always visible, remove condition.
          try { if (localStorage.getItem('userRole') === 'driver') btn.classList.remove('hidden'); } catch(_) { btn.classList.remove('hidden'); }

          btn.addEventListener('click', function(e){
            e.preventDefault();
            // Prefer shared helper if present
            if (window.openDriverRentalIframe && typeof window.openDriverRentalIframe === 'function'){
              try { window.openDriverRentalIframe(); return; } catch(_){}
            }
            // Fallback overlay
            openFallback();
          });

          // Also expose open/close for other scripts
          window.openDriverRentalModal = function(){ if (window.openDriverRentalIframe) return window.openDriverRentalIframe(); return openFallback(); };
          window.closeDriverRentalModal = closeFallback;
        });
      })();
    </script>
  </body>
</html>
    <script>
      function toggleSidebar(){
        const isDesktop = window.innerWidth >= 1024;
        if (isDesktop) {
          // On desktop, toggle collapse state (icon-only mode)
          toggleSidebarCollapse();
        } else {
          // On mobile, toggle sidebar visibility
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('sidebarOverlay');
          if (sidebar && overlay) {
            const isHidden = sidebar.classList.contains('-translate-x-full');
            if (isHidden) {
              sidebar.classList.remove('-translate-x-full');
              overlay.classList.remove('hidden');
            } else {
              sidebar.classList.add('-translate-x-full');
              overlay.classList.add('hidden');
            }
          }
        }
      }
      
      function toggleSidebarCollapse(){
        const body = document.body;
        const mainWrapper = document.getElementById('driverMainWrapper');
        const header = document.getElementById('driverHeaderContainer');
        const sidebar = document.getElementById('sidebar');
        if (!mainWrapper || !sidebar) return;
        
        const isDesktop = window.innerWidth >= 1024;
        if (!isDesktop) return; // Only allow collapse on desktop
        
        body.classList.toggle('sidebar-collapsed');
        const isCollapsed = body.classList.contains('sidebar-collapsed');
        
        // Update margins and padding
        mainWrapper.style.marginLeft = isCollapsed ? '5rem' : '16rem';
        if (header) header.style.paddingLeft = isCollapsed ? '5rem' : '16rem';
      }
      
      (function(){
        const closeBtn = document.getElementById('closeSidebarBtn');
        const overlay = document.getElementById('sidebarOverlay');
        const collapseBtn = document.getElementById('collapseSidebarBtn');
        
        if (closeBtn) closeBtn.addEventListener('click', function(){
          const sidebar = document.getElementById('sidebar');
          if (sidebar) sidebar.classList.add('-translate-x-full');
          if (overlay) overlay.classList.add('hidden');
        });
        
        if (overlay) overlay.addEventListener('click', function(){
          const sidebar = document.getElementById('sidebar');
          if (sidebar) sidebar.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
        });
        
        if (collapseBtn) {
          collapseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            toggleSidebarCollapse();
          });
        }
        
        window.addEventListener('resize', function(){
          const mainWrapper = document.getElementById('driverMainWrapper');
          const header = document.getElementById('driverHeaderContainer');
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('sidebarOverlay');
          const isDesktop = window.innerWidth >= 1024;
          
          if (isDesktop) {
            // On desktop, ensure sidebar is visible and respect collapsed state
            if (sidebar) sidebar.classList.remove('-translate-x-full');
            if (overlay) overlay.classList.add('hidden');
            
            const isCollapsed = document.body.classList.contains('sidebar-collapsed');
            if (mainWrapper) mainWrapper.style.marginLeft = isCollapsed ? '5rem' : '16rem';
            if (header) header.style.paddingLeft = isCollapsed ? '5rem' : '16rem';
          } else {
            // On mobile, reset to default hidden state
            if (mainWrapper) mainWrapper.style.marginLeft = '0';
            if (header) header.style.paddingLeft = '0';
            // Remove collapsed class on mobile
            document.body.classList.remove('sidebar-collapsed');
          }
        });
      })();
    </script>
