<div class="section-card rounded-xl mx-2 lg:mx-4" style="margin-left:calc(var(--sidebar-width,260px) + 36px); margin-right:24px; width:min(1100px, calc(100% - var(--sidebar-width,260px) - 132px));">
  <div class="p-4 lg:p-6 flex items-center justify-between">
    <button type="button" onclick="if (window.parent && typeof window.parent.showSection === 'function') window.parent.showSection('my-fields');" class="btn-primary text-white font-semibold px-4 py-2 rounded-md shadow-sm">
      My Fields
    </button>
    <p class="text-[var(--cane-600)] text-sm">Explore fields on the map</p>
  </div>
  <!-- The section-card is offset to the right of the sidebar so it does not sit underneath it.
       Reduce top padding to move the map area upward. Adjust the --sidebar-width variable
       if your sidebar width differs from 260px. -->
  <div class="map-wrapper">
  <div id="availableFieldsMap" class="rounded-xl border border-[var(--cane-200)] overflow-hidden" style="height:56vh; position:relative; margin-top:-0.5rem; margin-left:24px; width:calc(100% - 24px);">
      <!-- Move the search form inside the map so it's positioned over the map area -->
      <form id="afSearchForm" class="absolute right-10 top-6 z-[1000] bg-white/90 backdrop-blur rounded-md shadow flex items-center w-72">
        <input id="afSearchInput" type="text" class="w-full px-3 py-2 text-sm rounded-l-md focus:outline-none" placeholder="Search place or address" />
        <button type="submit" class="px-3 py-2 text-sm bg-gray-900 text-white rounded-r-md hover:bg-gray-800">
          <i class="fas fa-search"></i>
        </button>
      </form>
    </div>
  </div>
</div>
<script>
  // Try to invalidate Leaflet map size after the page renders
  // Assumes the Leaflet map instance is assigned to window.availableFieldsMap or window.map
  function ensureMapResize() {
    const map = window.availableFieldsMap || window.map;
    if (map && typeof map.invalidateSize === 'function') {
      // small delay to allow layout/animations to finish
      setTimeout(() => map.invalidateSize(), 200);
    }
  }

  // Run after DOM content loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureMapResize);
  } else {
    ensureMapResize();
  }

  // Also invalidate on search form submit in case the UI changes
  const afForm = document.getElementById('afSearchForm');
  if (afForm) {
    afForm.addEventListener('submit', (e) => {
      // let the search handler run, then resize
      setTimeout(ensureMapResize, 300);
    });
  }
</script>
