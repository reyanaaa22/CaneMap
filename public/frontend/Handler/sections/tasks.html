<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CaneMap - Task Panel</title>
	<link rel="stylesheet" href="/css/output.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		:root {
			--cane-50: #f7fee7;
			--cane-100: #ecfcca;
			--cane-200: #d8f999;
			--cane-300: #bbf451;
			--cane-400: #9ae600;
			--cane-500: #7ccf00;
			--cane-600: #5ea500;
			--cane-700: #497d00;
			--cane-800: #3c6300;
			--cane-900: #35530e;
			--cane-950: #192e03;
		}
		.section-card { background: white; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
		.btn-primary { background: linear-gradient(135deg, var(--cane-700), var(--cane-800)); color: #fff; }
		.btn-primary:hover { background: linear-gradient(135deg, var(--cane-800), var(--cane-900)); }
		.btn-secondary { background: #e5e7eb; color: #374151; }
		.btn-secondary:hover { background: #d1d5db; }
		.search-input {
			padding: 0.65rem 0.85rem;
			padding-left: 2.5rem; /* Space for search icon */
			border-radius: 0.75rem;
			border: 1px solid #d9e2ec;
			background: #ffffff;
			font-size: 0.85rem;
			transition: border-color 0.2s ease, box-shadow 0.2s ease;
		}
		.search-input:focus {
			outline: none;
			border-color: var(--cane-500);
			box-shadow: 0 0 0 3px rgba(124, 207, 0, 0.15);
		}
		table thead th {
			background: #f8fafc;
			font-size: 0.8rem;
			letter-spacing: 0.05em;
			text-transform: uppercase;
			color: #6b7280;
			font-weight: 600;
			padding: 1rem 1rem;
		}
		table tbody tr {
			transition: background-color 0.15s ease;
		}
		table tbody tr:hover {
			background-color: #f9fafb;
		}
		table tbody td {
			padding: 1.25rem 1rem;
			font-size: 0.95rem;
		}
		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			z-index: 50;
			align-items: center;
			justify-content: center;
		}
		.modal.active {
			display: flex;
		}
		.modal-content {
			background: linear-gradient(135deg, #ecfcca, #f7fee7);
			border-radius: 1rem;
			max-width: 900px;
			width: 90%;
			max-height: 90vh;
			overflow-y: auto;
		}
	</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
	<main class="container mx-auto px-4 lg:px-6 py-6 mt-12 mb-10">
		<!-- Task List Section -->
		<div class="section-card rounded-2xl p-6">
			<div class="mb-5">
				<h2 class="text-2xl font-bold text-[var(--cane-950)] mb-1 flex items-center gap-2">
					<span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-[var(--cane-100)] text-[var(--cane-700)]">
						<i class="fas fa-tasks"></i>
					</span>
					My Tasks
				</h2>
				<p class="text-sm text-gray-600">Manage and track all assigned tasks.</p>
			</div>

			<!-- Action Bar -->
			<div class="mb-4 flex flex-col sm:flex-row justify-between gap-3">
				<button id="createTaskBtn" class="btn-primary px-5 py-2.5 rounded-lg font-semibold shadow-md transition-all hover:shadow-lg">
					<i class="fas fa-plus mr-2"></i>Create Task
				</button>
				<div class="relative flex-1 sm:max-w-xs">
					<i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-sm text-gray-400"></i>
					<input id="searchTasks" type="text" placeholder="Search tasks..." class="search-input pl-9 w-full" />
				</div>
			</div>

			<!-- Tasks Table -->
			<div class="overflow-hidden rounded-xl border border-gray-200">
				<table class="min-w-full">
					<thead>
						<tr>
							<th class="text-left">Task Title</th>
							<th class="text-left">Field</th>
							<th class="text-left">Deadline</th>
							<th class="text-left">Status</th>
							<th class="text-right">Actions</th>
						</tr>
					</thead>
					<tbody id="tasksTbody">
						<!-- Tasks will be loaded dynamically from Firestore -->
					</tbody>
				</table>
			</div>

			<!-- Empty State (hidden by default) -->
			<div id="tasksEmpty" class="hidden mt-4 rounded-xl border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
				<div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-white text-gray-400 shadow-inner">
					<i class="fas fa-tasks text-2xl"></i>
				</div>
				<h3 class="mt-4 text-lg font-semibold text-gray-900">No tasks yet</h3>
				<p class="mt-2 text-sm text-gray-600">Create your first task to get started.</p>
			</div>
		</div>
	</main>

	<!-- Modal for Task Assignment Form -->
	<div id="taskModal" class="modal">
		<div class="modal-content p-8">
			<div class="flex items-center justify-between mb-6">
				<div class="flex items-center gap-3">
					<button id="closeModalBtn" class="text-gray-600 hover:text-gray-800">
						<i class="fas fa-arrow-left text-xl"></i>
					</button>
					<h2 class="text-2xl font-bold text-[var(--cane-900)]">Task Assignment Form</h2>
				</div>
			</div>

			<form id="taskForm" class="space-y-6">
				<!-- Top fields -->
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					<div>
						<label class="block text-sm font-semibold text-[var(--cane-800)] mb-2">Task Title:</label>
						<input id="taskTitle" type="text" placeholder="Enter task title" class="w-full px-4 py-2.5 border-2 border-[var(--cane-300)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--cane-500)] focus:border-[var(--cane-500)] text-[var(--cane-900)] bg-white"/>
					</div>
					<div>
						<label class="block text-sm font-semibold text-[var(--cane-800)] mb-2">Select Field:</label>
						<select id="fieldSelect" class="w-full px-4 py-2.5 border-2 border-[var(--cane-300)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--cane-500)] focus:border-[var(--cane-500)] text-[var(--cane-900)] bg-white">
							<option value="">Choose field‚Ä¶</option>
							<option>Lot A1 - Naungan</option>
							<option>Lot B2 - Ipil</option>
							<option>Lot C3 - Linao</option>
						</select>
					</div>
					<div>
						<label class="block text-sm font-semibold text-[var(--cane-800)] mb-2">Assigned Date:</label>
						<input id="assignedDate" type="date" placeholder="dd/mm/yyyy" class="w-full px-4 py-2.5 border-2 border-[var(--cane-300)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--cane-500)] focus:border-[var(--cane-500)] text-[var(--cane-900)] bg-white"/>
					</div>
					<div>
						<label class="block text-sm font-semibold text-[var(--cane-800)] mb-2">Assigned Time:</label>
						<input id="assignedTime" type="time" placeholder="--:-- --" class="w-full px-4 py-2.5 border-2 border-[var(--cane-300)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--cane-500)] focus:border-[var(--cane-500)] text-[var(--cane-900)] bg-white"/>
					</div>
				</div>

				<!-- Assigned to -->
				<div>
					<label class="block text-sm font-semibold text-[var(--cane-800)] mb-2">Assigned to:</label>
					<div class="flex items-center space-x-2 mb-3 text-[var(--cane-800)]">
						<input id="filterDriver" type="checkbox" class="w-4 h-4 border-gray-300 rounded">
						<label for="filterDriver" class="text-sm">Show only workers with Driver Badge</label>
					</div>
					<select id="workerSelect" class="w-full px-4 py-2.5 border-2 border-[var(--cane-300)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--cane-500)] focus:border-[var(--cane-500)] text-[var(--cane-900)] bg-white">
						<option value="">Select worker‚Ä¶</option>
						<option>Maria Sanchez</option>
						<option>Peter Romero (Driver)</option>
						<option>Anna Reyes</option>
						<option>Carl Ramos (Driver)</option>
					</select>
				</div>

				<!-- Description -->
				<div>
					<label class="block text-sm font-semibold text-[var(--cane-800)] mb-2">Task Description:</label>
					<textarea id="taskDesc" rows="6" class="w-full px-4 py-2.5 border-2 border-[var(--cane-300)] rounded-lg resize-y focus:outline-none focus:ring-2 focus:ring-[var(--cane-500)] focus:border-[var(--cane-500)] text-[var(--cane-900)] bg-white" placeholder="Add details, instructions, tools, etc."></textarea>
				</div>

				<!-- Actions -->
				<div class="flex items-center justify-end space-x-3">
					<button type="button" id="cancelFormBtn" class="btn-secondary px-6 py-2.5 rounded-lg font-semibold">Cancel</button>
					<button type="submit" class="btn-primary px-6 py-2.5 rounded-lg font-semibold shadow-md">Assign Task</button>
				</div>
			</form>
		</div>
	</div>

	<script type="module">
		console.log('‚ö° Tasks tab script is executing!');

		import { db, auth } from '../../../backend/Common/firebase-config.js';
		import { collection, query, where, getDocs, orderBy, onSnapshot, getDoc, doc } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
		import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';

		// ‚úÖ Use global flag to prevent multiple script executions
		if (window.__tasksTabInitialized) {
			console.warn('‚ö†Ô∏è Tasks tab already initialized, skipping!');
		} else {
			window.__tasksTabInitialized = true;
			console.log('‚úÖ Initializing tasks tab for the first time');

			let currentUserId = null;
			let tasksUnsubscribe = null;

			onAuthStateChanged(auth, user => {
				console.log('üîê Auth state changed in tasks tab');
				if (user && !currentUserId) {
					currentUserId = user.uid;
					loadTasks();
				}
			});

			// Load tasks from Firestore
			async function loadTasks() {
				console.log('üì• loadTasks() called');
				const tbody = document.getElementById('tasksTbody');
				const emptyState = document.getElementById('tasksEmpty');

				tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Loading tasks...</td></tr>';

				// ‚úÖ Cleanup previous listener if exists
				if (tasksUnsubscribe) {
					console.log('üßπ Cleaning up previous tasks listener');
					tasksUnsubscribe();
					tasksUnsubscribe = null;
				}

			try {
				// Query tasks where current user is the handler/creator
				const tasksQuery = query(
					collection(db, 'tasks'),
					where('created_by', '==', currentUserId)
				);

				// Real-time listener
				tasksUnsubscribe = onSnapshot(tasksQuery, (snapshot) => {
					console.log(`üî• onSnapshot fired! Found ${snapshot.docs.length} tasks, tbody has ${tbody.children.length} rows before clear`);

					// Sort in memory instead of in query to avoid needing an index
					const docs = snapshot.docs.sort((a, b) => {
						const aTime = a.data().created_at?.seconds || 0;
						const bTime = b.data().created_at?.seconds || 0;
						return bTime - aTime; // Descending order
					});

					tbody.innerHTML = '';
					console.log(`üßπ Cleared tbody, now has ${tbody.children.length} rows`);

					if (docs.length === 0) {
						emptyState.classList.remove('hidden');
						return;
					}

					emptyState.classList.add('hidden');

					// Render all tasks synchronously (NO await - use placeholders)
					docs.forEach(docSnap => {
						const task = docSnap.data();
						const taskId = docSnap.id;

						// Use placeholders - will load async after render
						const fieldId = task.fieldId || task.field_id || null;
						let fieldName = 'Loading...';
						let assignedTo = task.assignedTo && task.assignedTo.length > 0 ? `${task.assignedTo.length} worker(s)` : 'Not assigned';

						// Format date - try scheduled_at first, then deadline, then createdAt
						let dateStr = '‚Äî';
						const timeField = task.scheduled_at || task.deadline || task.createdAt;
						if (timeField) {
							const date = timeField.toDate ? timeField.toDate() : new Date(timeField);
							dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
						}

						// Status badge
						const statusColors = {
							'todo': 'bg-gray-100 text-gray-700',
							'pending': 'bg-yellow-100 text-yellow-700',
							'in_progress': 'bg-blue-100 text-blue-700',
							'completed': 'bg-green-100 text-green-700',
							'done': 'bg-green-100 text-green-700'
						};
						const statusColor = statusColors[task.status] || 'bg-gray-100 text-gray-700';
						const statusText = task.status || 'todo';

						const row = document.createElement('tr');
						row.innerHTML = `
							<td class="font-medium text-gray-900">${escapeHtml(task.title)}</td>
							<td class="text-gray-600" data-field-id="${fieldId}" data-row-id="${taskId}">Loading...</td>
							<td class="text-gray-600" data-assigned-to="${(task.assignedTo || []).join(',')}" data-row-id="${taskId}">${assignedTo}</td>
							<td class="text-gray-600">${dateStr}</td>
							<td>
								<span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${statusColor}">
									${statusText}
								</span>
							</td>
							<td class="text-right">
								<button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="viewTaskDetails('${taskId}')">
									<i class="fas fa-eye"></i>
								</button>
							</td>
						`;
						tbody.appendChild(row);

						// Async load field name and user names AFTER rendering
						if (fieldId) {
							getDoc(doc(db, 'fields', fieldId)).then(fieldDoc => {
								if (fieldDoc.exists()) {
									const fieldData = fieldDoc.data();
									const fieldCell = row.querySelector(`[data-field-id="${fieldId}"][data-row-id="${taskId}"]`);
									if (fieldCell) {
										fieldCell.textContent = fieldData.field_name || fieldData.fieldName || 'Field';
									}
								}
							}).catch(() => {});
						}

						// Load worker names
						if (task.assignedTo && task.assignedTo.length > 0) {
							Promise.all(task.assignedTo.map(userId => getDoc(doc(db, 'users', userId))))
								.then(userDocs => {
									const names = userDocs.filter(d => d.exists()).map(d => d.data().name || d.data().email || 'Unknown');
									const assignedCell = row.querySelector(`[data-assigned-to][data-row-id="${taskId}"]`);
									if (assignedCell) {
										assignedCell.textContent = names.length > 0 ? names.join(', ') : 'Not assigned';
									}
								}).catch(() => {});
						}
					});

					console.log(`‚úÖ Finished rendering, tbody now has ${tbody.children.length} rows`);
				});
			} catch (err) {
				console.error('Error loading tasks:', err);
				tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading tasks</td></tr>';
			}
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text || '';
			return div.innerHTML;
		}

		// Make viewTaskDetails available globally
		window.viewTaskDetails = async function(taskId) {
			console.log('View task:', taskId);

			try {
				// Fetch task details
				const taskDoc = await getDoc(doc(db, 'tasks', taskId));
				if (!taskDoc.exists()) {
					alert('Task not found');
					return;
				}

				const task = taskDoc.data();

				// Get field name
				let fieldName = '‚Äî';
				const fieldId = task.fieldId || task.field_id || null;
				if (fieldId) {
					try {
						const fieldDoc = await getDoc(doc(db, 'fields', fieldId));
						if (fieldDoc.exists()) {
							const fieldData = fieldDoc.data();
							fieldName = fieldData.field_name || fieldData.fieldName || 'Field';
						}
					} catch (err) {
						console.error('Error fetching field:', err);
					}
				}

				// Format date - try scheduled_at first, then deadline, then createdAt
				let dateStr = '‚Äî';
				const timeField = task.scheduled_at || task.deadline || task.createdAt;
				if (timeField) {
					const date = timeField.toDate ? timeField.toDate() : new Date(timeField);
					dateStr = date.toLocaleDateString('en-US', {
						weekday: 'long',
						month: 'long',
						day: 'numeric',
						year: 'numeric',
						hour: '2-digit',
						minute: '2-digit'
					});
				}

				// Format assigned to - based on REQUIREMENTS.md, assignedTo is array<userId>
				let assignedTo = 'Not assigned';
				if (task.assignedTo && Array.isArray(task.assignedTo) && task.assignedTo.length > 0) {
					try {
						// Fetch user names for assigned users
						const userNames = [];
						for (const userId of task.assignedTo) {
							const userDoc = await getDoc(doc(db, 'users', userId));
							if (userDoc.exists()) {
								const userData = userDoc.data();
								userNames.push(userData.name || userData.email || 'Unknown');
							}
						}
						assignedTo = userNames.length > 0 ? userNames.join(', ') : 'Not assigned';
					} catch (err) {
						console.error('Error fetching assigned users:', err);
						assignedTo = `${task.assignedTo.length} user(s)`;
					}
				}

				// Create modal
				const modal = document.createElement('div');
				modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4';
				modal.innerHTML = `
					<div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
						<div class="p-6 border-b">
							<div class="flex items-start justify-between">
								<div>
									<h3 class="text-2xl font-bold text-gray-900">${escapeHtml(task.title)}</h3>
									<p class="text-sm text-gray-600 mt-1">Task Details</p>
								</div>
								<button class="text-gray-400 hover:text-gray-600" id="closeTaskDetailsModal">
									<i class="fas fa-times text-xl"></i>
								</button>
							</div>
						</div>

						<div class="p-6 space-y-4">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div class="bg-gray-50 rounded-lg p-4">
									<div class="text-xs text-gray-600 font-medium mb-1">Field</div>
									<div class="text-sm font-semibold text-gray-900">${escapeHtml(fieldName)}</div>
								</div>

								<div class="bg-gray-50 rounded-lg p-4">
									<div class="text-xs text-gray-600 font-medium mb-1">Status</div>
									<div class="text-sm font-semibold text-gray-900">${escapeHtml(task.status || 'todo')}</div>
								</div>

								<div class="bg-gray-50 rounded-lg p-4">
									<div class="text-xs text-gray-600 font-medium mb-1">Scheduled Date</div>
									<div class="text-sm font-semibold text-gray-900">${dateStr}</div>
								</div>

								<div class="bg-gray-50 rounded-lg p-4">
									<div class="text-xs text-gray-600 font-medium mb-1">Assigned To</div>
									<div class="text-sm font-semibold text-gray-900">${escapeHtml(assignedTo)}</div>
								</div>
							</div>

							${task.details ? `
								<div class="bg-gray-50 rounded-lg p-4">
									<div class="text-xs text-gray-600 font-medium mb-2">Details</div>
									<div class="text-sm text-gray-900">${escapeHtml(task.details)}</div>
								</div>
							` : ''}

							${task.notes ? `
								<div class="bg-gray-50 rounded-lg p-4">
									<div class="text-xs text-gray-600 font-medium mb-2">Notes</div>
									<div class="text-sm text-gray-900">${escapeHtml(task.notes)}</div>
								</div>
							` : ''}
						</div>

						<div class="p-6 border-t flex justify-end">
							<button class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700" id="closeTaskDetailsModalBtn">
								Close
							</button>
						</div>
					</div>
				`;

				document.body.appendChild(modal);

				// Close handlers
				modal.querySelector('#closeTaskDetailsModal').addEventListener('click', () => modal.remove());
				modal.querySelector('#closeTaskDetailsModalBtn').addEventListener('click', () => modal.remove());
				modal.addEventListener('click', (e) => {
					if (e.target === modal) modal.remove();
				});

			} catch (err) {
				console.error('Error loading task details:', err);
				alert('Failed to load task details: ' + err.message);
			}
		};

		// Create Task button - redirect to fields page where they can select a field and create tasks
		const createTaskBtn = document.getElementById('createTaskBtn');
		createTaskBtn.addEventListener('click', () => {
			// Show info modal
			const infoModal = document.createElement('div');
			infoModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/40';
			infoModal.innerHTML = `
				<div class="bg-white rounded-xl p-6 max-w-md mx-4 text-center">
					<div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
						<i class="fas fa-info-circle text-3xl text-blue-600"></i>
					</div>
					<h3 class="text-xl font-bold mb-3">Create Task</h3>
					<p class="text-gray-600 mb-6">To create a task, go to <strong>My Fields</strong> and select a field. You can then create tasks for that specific field.</p>
					<button class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
						Got it
					</button>
				</div>
			`;
			document.body.appendChild(infoModal);

			infoModal.querySelector('button').addEventListener('click', () => {
				infoModal.remove();
			});
		});

		// Search functionality
		document.getElementById('searchTasks').addEventListener('input', (e) => {
			const searchTerm = e.target.value.toLowerCase();
			const rows = document.querySelectorAll('#tasksTbody tr');

			rows.forEach(row => {
				const text = row.textContent.toLowerCase();
				row.style.display = text.includes(searchTerm) ? '' : 'none';
			});
		});
	} // ‚úÖ End of if (!window.__tasksTabInitialized)
	</script>
</body>
</html>

