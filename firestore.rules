rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to safely check user role
    function getUserRole() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }

    function isAdmin() {
      return request.auth != null && getUserRole() in ['admin', 'sra', 'handler', 'system_admin'];
    }

    // Users can read their own data, System Admins can read all users
    match /users/{userId} {
      allow read, write: if request.auth != null && (
        request.auth.uid == userId ||
      // system staff (admin, sra, system_admin)
      (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sra', 'handler', 'system_admin']) ||

      // handler who owns a field that this user joined
      exists(/databases/$(database)/documents/field_workers)
        && (
          exists(
            /databases/$(database)/documents/field_workers/$(request.auth.uid + '_' + userId)
          )
        )
    );

    // only the owner or admin roles can write
    allow write: if request.auth != null && (
      request.auth.uid == userId ||
      (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sra', 'handler', 'system_admin'])
    );
  }
    
    match /users/{userId} {
      // allow any authenticated user to read basic user profiles (fullname, displayName, email if you want)
      allow get: if request.auth != null;
      // keep write restrictions
      allow write: if request.auth != null && (
        request.auth.uid == userId ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sra', 'handler', 'system_admin'])
      );
    }
    
    // Allow unauthenticated verification link to read and update
    match /users/{userId} {
      // Allow reading unverified users (needed for verify.html)
      allow read: if request.auth == null && resource.data.emailVerified == false;

      // Allow updating emailVerified ‚Üí true and status ‚Üí "verified"
      allow update: if
        request.auth == null &&
        request.resource.data.emailVerified == true &&
        resource.data.emailVerified == false &&
        request.resource.data.status == "verified";
    }

    // Allow creation of users for SRA Officer registration and system admin auto-creation
    match /users/{userId} {
      // Allow user to create/update their own document OR allow creating SRA officers
      allow create: if request.auth != null && (
        request.auth.uid == userId ||
        (request.resource.data.role == 'sra' &&
         request.resource.data.email != null &&
         request.resource.data.name != null)
      );

      // Allow user to read their own document even if they don't have a role yet
      allow get: if request.auth != null && request.auth.uid == userId;

      // Allow user to update their own document
      allow update: if request.auth != null && request.auth.uid == userId;
    }


    // System Admin access to all collections for dashboard analytics
    match /{document=**} {
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'system_admin';
    }
    
    // Allow creation of notifications
    match /notifications/{notificationId} {
      // Anyone can read their notifications
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Handlers and staff can create notifications
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
          'handler', 'sra', 'admin', 'system_admin'
        ];

      // Users can mark their own notifications as read
      allow update: if request.auth != null &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.status == "read";
    }
    
    // Allow creation of email_queue
    match /email_queue/{emailId} {
      allow create, read, update, delete: if request.auth != null;
    }

    // Allow public submission of feedbacks; only system_admin can read/manage them
    match /feedbacks/{feedbackId} {
      // Allow anyone (even unauthenticated) to create feedback entries so users can send quick feedback.
      allow create: if true;

      // Only system_admin users can read, update or delete feedback entries
      allow read, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'system_admin';
    }
    
    match /fields/{fieldId} {
      // Anyone authenticated can read fields
      allow read: if request.auth != null;

      // ‚úÖ Allow verified landowners, admins, and SRA officers to create fields
      allow create: if request.auth != null && (
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'handler' &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'verified'
        )
        ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sra', 'system_admin']
      );

      // ‚úÖ Allow the field owner or staff to update their fields
      allow update: if request.auth != null && (
        resource.data.landowner_id == request.auth.uid ||
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sra', 'system_admin']
      );

      // ‚úÖ Allow delete only by owner or staff
      allow delete: if request.auth != null && (
        resource.data.landowner_id == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'sra', 'system_admin']
      );
    }
    
    // --- Nested field applications (for each user) ---
    match /field_applications/{uid}/fields/{fieldId} {
      allow read: if request.auth != null;  // anyone authenticated can read
      allow create: if request.auth != null && request.auth.uid == uid;

      // ‚úÖ Allow landowner to update their own field OR allow SRA/Admin to update
      allow update: if request.auth != null && (
        request.auth.uid == uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin']
      );
    }


    // Allow SRA/Admin to add remarks inside each field application
    match /field_applications/{uid}/fields/{fieldId}/remarks/{remarkId} {
      allow read: if request.auth != null && (
        request.auth.uid == uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin']
      );

      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin'];
    }

    // --- Needed so collectionGroup('fields') queries can read anywhere ---
    match /{path=**}/fields/{fieldId} {
      allow read: if request.auth != null;  // allows nested reads for authenticated users
    }

    // Field workers (join requests) access rules
    match /field_workers/{requestId} {
      // Users can read their own requests
      allow read: if request.auth != null && 
        (resource.data.user_uid == request.auth.uid || 
         get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid);
      
      // Users can create join requests for any field
      allow create: if request.auth != null && 
        request.resource.data.user_uid == request.auth.uid;
      
      // Only the field owner can update join requests (approve/reject)
      allow update: if request.auth != null && 
        get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid;
      
      // Users can delete their own requests, field owners can delete requests for their fields
      allow delete: if request.auth != null && 
        (resource.data.user_uid == request.auth.uid || 
         get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid);
         
        
    }
    
    // Task logs access rules
    match /task_logs/{logId} {
      // Field workers can read logs for fields they're approved to work on
      allow read: if request.auth != null && 
        (resource.data.user_uid == request.auth.uid || 
         get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid);
      
      // Approved field workers can create task logs
      allow create: if request.auth != null && 
        request.resource.data.user_uid == request.auth.uid &&
        exists(/databases/$(database)/documents/field_workers/$(request.auth.uid + '_' + resource.data.field_id)) &&
        get(/databases/$(database)/documents/field_workers/$(request.auth.uid + '_' + resource.data.field_id)).data.status == 'approved';
      
      // Users can update their own task logs
      allow update: if request.auth != null && 
        resource.data.user_uid == request.auth.uid;
      
      // Users can delete their own task logs, field owners can delete logs for their fields
      allow delete: if request.auth != null && 
        (resource.data.user_uid == request.auth.uid || 
         get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid);
    }
    
    // Reports access rules
    match /reports/{reportId} {
      // Field owners can read reports for their fields
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid;
      
      // Field owners can create reports for their fields
      allow create: if request.auth != null && 
        get(/databases/$(database)/documents/fields/$(request.resource.data.field_id)).data.landowner_id == request.auth.uid;
      
      // Field owners can update reports for their fields
      allow update: if request.auth != null && 
        get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid;
      
      // Field owners can delete reports for their fields
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid;
    }

  // Drivers Badge applications
  match /Drivers_Badge/{docId} {
    // Owner can create exactly once; docId must equal uid
    allow create: if request.auth != null &&
      docId == request.auth.uid &&
      request.resource.data.requestedBy == request.auth.uid &&
      !exists(/databases/$(database)/documents/Drivers_Badge/$(request.auth.uid));

    // Allow unauthenticated admin (PIN login) to view badge data
    allow read: if true;

    // Owner can update at most once every 30 days; officers/admins/system_admins can always update
    allow update: if request.auth != null && (
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin'] ||
      (
        resource.data.requestedBy == request.auth.uid &&
        (
          resource.data.status == 'rejected' ||  // ‚úÖ allow immediate resubmit after rejection
          !resource.data.lastEdit ||
          (request.time.toMillis() - resource.data.lastEdit.toMillis() >= 30 * 24 * 60 * 60 * 1000)
        )
      )
    );

    // Allow deletes by owner or staff. For full cascade on account deletion, use a Cloud Function.
    allow delete: if request.auth != null && (
      resource.data.requestedBy == request.auth.uid ||
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
    );
  }

    
    // Allow admin dashboard to fetch Driver Badge requests
    match /Drivers_Badge/{docId} {
      // Allow read for your local dashboard (PIN-based admin)
      allow read: if true;
      // Keep write actions protected
      allow write: if request.auth != null;
    }
    
        // === System Admin Login Security Collections ===
    match /admin_pins/{pinId} {
      // Allow reading PINs for login (before authentication)
      allow read: if true;

      // Allow creating default admin PIN only when no users exist (setup stage)
      allow create: if request.auth != null || true;

      // System Admins can manage PINs
      allow update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'system_admin';
    }

    match /admin_security_logs/{logId} {
      // ‚úÖ Allow login page to log failed attempts (unauthenticated)
      allow create: if true;

      // ‚úÖ Allow unauthenticated read of limited recent logs (only specific fields)
      allow get, list: if request.auth == null;

      // ‚úÖ Full access for authenticated system admins
      allow read, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['system_admin', 'super_admin', 'security_admin'];
    }

    // Failed login attempts for non-existent users
    match /failed_logins/{attemptId} {
      // Allow anyone (including unauthenticated) to create failed login records
      allow create: if true;

      // Only system_admin can read failed login attempts
      allow read, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'system_admin';
    }

    // Allow unauthenticated read and update for failed login tracking
    match /users/{userId} {
      // Allow unauthenticated queries to check if an email exists (for failed login tracking)
      // This is safe because we're only exposing email existence, not sensitive data
      allow read: if request.auth == null;

      // Allow unauthenticated updates ONLY to increment failedLoginAttempts
      // This is needed because failed login attempts happen BEFORE authentication
      allow update: if request.auth == null &&
        // Only failedLoginAttempts and lastFailedLogin can be modified
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['failedLoginAttempts', 'lastFailedLogin']) &&
        // Ensure failedLoginAttempts is a non-negative integer
        request.resource.data.failedLoginAttempts is int &&
        request.resource.data.failedLoginAttempts >= 0 &&
        // Ensure it only increases (security measure to prevent tampering)
        request.resource.data.failedLoginAttempts >= resource.data.failedLoginAttempts;
    }

    // === Field Joins (per user, multiple fields under join_fields) ===
    match /field_joins/{userId} {
      // Allow user and SRA/Admins/System Admin to read
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
      );

      // Allow user to create their join container doc
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow user or sysadmin to update/delete their own doc
      allow update, delete: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'system_admin'
      );

      // üü¢ Allow subcollection "join_fields" so each user can join multiple fields
      match /join_fields/{fieldId} {
        // User can manage their own join documents
        allow read, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
// --- Allow collectionGroup queries for join_fields (needed for collectionGroup reads) ---
match /{path=**}/join_fields/{joinId} {
  allow read: if request.auth != null && (
    // 1Ô∏è‚É£ User who created the join request (check both userId and user_uid for compatibility)
    request.auth.uid == resource.data.user_uid ||
    request.auth.uid == resource.data.userId ||
    request.auth.uid == resource.data.user_id ||
    
    // 2Ô∏è‚É£ Handler role - allow reading ALL join_fields (client-side filtering will ensure only their fields)
    // This is necessary for collectionGroup queries to work efficiently
    // Put this BEFORE field ownership check to avoid nested reads for each document
    (
      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'handler'
    )
    ||
    // 3Ô∏è‚É£ Staff roles (SRA/Admin/System Admin) - can read all
    (
      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
    )
    ||
    // 4Ô∏è‚É£ Handler who owns the field - check field ownership (fallback for non-handlers)
    (
      resource.data.fieldId != null &&
      (
        // Option A: Check top-level fields collection - try multiple owner field names
        (
          exists(/databases/$(database)/documents/fields/$(resource.data.fieldId)) &&
          (
            // Check userId first (most common based on Register-field.js)
            get(/databases/$(database)/documents/fields/$(resource.data.fieldId)).data.userId == request.auth.uid ||
            // Check landowner_id
            get(/databases/$(database)/documents/fields/$(resource.data.fieldId)).data.landowner_id == request.auth.uid ||
            // Check user_id
            get(/databases/$(database)/documents/fields/$(resource.data.fieldId)).data.user_id == request.auth.uid ||
            // Check registered_by
            get(/databases/$(database)/documents/fields/$(resource.data.fieldId)).data.registered_by == request.auth.uid
          )
        )
        ||
        // Option B: Check nested field_applications
        exists(/databases/$(database)/documents/field_applications/$(request.auth.uid)/fields/$(resource.data.fieldId))
      )
    )
  );

  // Allow creation of join requests (by the joining user) - check both userId and user_uid
  allow create: if request.auth != null && (
    request.resource.data.user_uid == request.auth.uid ||
    request.resource.data.userId == request.auth.uid ||
    request.resource.data.user_id == request.auth.uid
  );

  // Allow update/delete by staff or by field owner
  allow update, delete: if request.auth != null && (
    (
      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
    )
    ||
    (
      resource.data.fieldId != null &&
      (
        // Check top-level fields collection (check multiple owner fields)
        (
          exists(/databases/$(database)/documents/fields/$(resource.data.fieldId)) &&
          (
            get(/databases/$(database)/documents/fields/$(resource.data.fieldId)).data.landowner_id == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.fieldId)).data.userId == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.fieldId)).data.user_id == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.fieldId)).data.registered_by == request.auth.uid
          )
        )
        ||
        // Check nested field_applications
        exists(/databases/$(database)/documents/field_applications/$(request.auth.uid)/fields/$(resource.data.fieldId))
      )
    )
  );
}


match /field_workers/{requestId} {
  // Allow reading join requests if:
  allow read: if request.auth != null && (
    // User who created the join request
    resource.data.user_uid == request.auth.uid ||
    resource.data.userId == request.auth.uid ||
    resource.data.user_id == request.auth.uid ||

    // Handler/Landowner who owns the field (check both possible paths and multiple owner fields)
    (
      resource.data.field_id != null &&
      (
        // Case 1: top-level fields - check multiple owner field names
        (
          exists(/databases/$(database)/documents/fields/$(resource.data.field_id)) &&
          (
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.userId == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.user_id == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.registered_by == request.auth.uid
          )
        )
        ||
        // Case 2: nested field_applications/{uid}/fields/{fieldId}
        (
          exists(/databases/$(database)/documents/field_applications/$(request.auth.uid)/fields/$(resource.data.field_id))
        )
      )
    )
    ||
    // Staff roles can read everything
    (
      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
    )
    ||
    // Handler role - allow reading (client-side will filter by field ownership)
    (
      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'handler'
    )
  );

  // Users can create join requests for any field
  allow create: if request.auth != null && (
    request.resource.data.user_uid == request.auth.uid ||
    request.resource.data.userId == request.auth.uid ||
    request.resource.data.user_id == request.auth.uid
  );

  // Only the field owner can update join requests (approve/reject) - check multiple owner fields
  allow update: if request.auth != null && (
    // Staff can update
    (
      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
    )
    ||
    // Field owner can update - check multiple owner fields
    (
      resource.data.field_id != null &&
      (
        (
          exists(/databases/$(database)/documents/fields/$(resource.data.field_id)) &&
          (
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.userId == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.user_id == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.registered_by == request.auth.uid
          )
        )
        ||
        exists(/databases/$(database)/documents/field_applications/$(request.auth.uid)/fields/$(resource.data.field_id))
      )
    )
  );

  // Users or owners can delete
  allow delete: if request.auth != null && (
    resource.data.user_uid == request.auth.uid ||
    resource.data.userId == request.auth.uid ||
    resource.data.user_id == request.auth.uid ||
    (
      resource.data.field_id != null &&
      (
        (
          exists(/databases/$(database)/documents/fields/$(resource.data.field_id)) &&
          (
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.userId == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.landowner_id == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.user_id == request.auth.uid ||
            get(/databases/$(database)/documents/fields/$(resource.data.field_id)).data.registered_by == request.auth.uid
          )
        )
        ||
        exists(/databases/$(database)/documents/field_applications/$(request.auth.uid)/fields/$(resource.data.field_id))
      )
    )
  );
}


  }
}