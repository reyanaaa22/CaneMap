<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .container {
    background: white;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  h2 {
    text-align: center;
    margin-bottom: 20px;
  }
  input {
    width: 95%;
    padding-right: 10px;
    padding: 10px;
    margin: 8px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    width: 100%;
    padding: 10px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover {
    background: #218838;
  }
  .alert {
    padding: 10px;
    margin-top: 10px;
    border-radius: 5px;
    text-align: center;
    font-size: 14px;
    display: none;
  }
  .error {
    background: #f8d7da;
    color: #721c24;
  }
  .success {
    background: #d4edda;
    color: #155724;
  }
  .warning {
    background: #fff3cd;
    color: #856404;
  }

  .signup-text {
  text-align: center;
  margin-top: 15px;
  font-size: 14px;
}

.signup-text a {
  color: #155724;
  text-decoration: none;
}

.signup-text a:hover {
  text-decoration: underline;
}

.forgot-pass {
  text-align: right;
  margin: 5px 0 10px;
  font-size: 13px;
}

.forgot-pass a {
  color: #155724;
  text-decoration: none;
}

.forgot-pass a:hover {
  text-decoration: underline;
}

</style>
</head>
<body>

<div class="container">
  <h2>Login</h2>
  <form id="loginForm">
    <input type="email" id="email" placeholder="Email" required>
    
    <input type="password" id="password" placeholder="Password" required>
    <p class="forgot-pass">
      <a href="../viewss/farmers_forgotpass.html">Forgot password?</a>
    </p>

    <button type="submit">Login</button>
  </form>

  <div id="alertBox" class="alert"></div>

  <p class="signup-text">
    Don't have an account yet? 
    <a href="../viewss/signup.html">Sign up here</a>
  </p>
</div>



<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWcIMy6hBF4aP6LTSS1PwtmZogUebAI4A",
    authDomain: "canemap-system.firebaseapp.com",
    projectId: "canemap-system",
    storageBucket: "canemap-system.firebasestorage.app",
    messagingSenderId: "624993566775",
    appId: "1:624993566775:web:5b1b72cb58203b46123fb2",
    measurementId: "G-08KFJQ1NEJ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const alertBox = document.getElementById("alertBox");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginButton = document.querySelector("button[type='submit']");

  const MAX_ATTEMPTS = 5;
  const LOCK_TIME = 60 * 1000; // 1 minute

  function showAlert(message, type) {
    alertBox.textContent = message;
    alertBox.className = `alert ${type}`;
    alertBox.style.display = "block";
  }

  function disableForm(seconds) {
    emailInput.disabled = true;
    passwordInput.disabled = true;
    loginButton.disabled = true;

    let remaining = seconds;
    loginButton.textContent = `Try again in ${remaining}s`;

    const countdown = setInterval(() => {
      remaining--;
      loginButton.textContent = `Try again in ${remaining}s`;

      if (remaining <= 0) {
        clearInterval(countdown);
        emailInput.disabled = false;
        passwordInput.disabled = false;
        loginButton.disabled = false;
        loginButton.textContent = "Login";
        alertBox.style.display = "none";
      }
    }, 1000);
  }

  function isLocked() {
    const lockUntil = localStorage.getItem("lockUntil");
    if (lockUntil && Date.now() < parseInt(lockUntil)) {
      const remaining = Math.ceil((parseInt(lockUntil) - Date.now()) / 1000);
      showAlert(`Too many failed attempts. Try again in ${remaining} seconds.`, "error");
      disableForm(remaining);
      return true;
    }
    return false;
  }

  function recordFailedAttempt() {
    let attempts = parseInt(localStorage.getItem("loginAttempts") || "0") + 1;
    localStorage.setItem("loginAttempts", attempts);

    if (attempts >= MAX_ATTEMPTS) {
      localStorage.setItem("lockUntil", Date.now() + LOCK_TIME);
      localStorage.setItem("loginAttempts", 0);
      showAlert(`Too many failed attempts. Please try again in ${LOCK_TIME / 1000} seconds.`, "error");
      disableForm(LOCK_TIME / 1000);
    }
  }

  function resetAttempts() {
    localStorage.setItem("loginAttempts", 0);
    localStorage.removeItem("lockUntil");
  }

  async function login() {
    if (isLocked()) return;

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);

      if (!userCredential.user.emailVerified) {
        showAlert("Please verify your email before logging in.", "error");
        passwordInput.value = "";
        recordFailedAttempt();
        return;
      }

      resetAttempts();
      showAlert("Login successful!", "success");
      setTimeout(() => window.location.href = "dashboard.html", 1500);

    } catch (error) {
      if (error.code === "auth/invalid-credential") {
        showAlert("Invalid credentials. Please check your email and password.", "error");
      } else {
        showAlert("Login failed: " + error.message, "error");
      }
      passwordInput.value = "";
      recordFailedAttempt();
    }
  }

  document.getElementById("loginForm").addEventListener("submit", (e) => {
    e.preventDefault();
    login();
  });

  document.querySelectorAll("#email, #password").forEach(input => {
    input.addEventListener("focus", () => {
      alertBox.style.display = "none";
    });
  });

  //auto-disable forms & button
  isLocked();
</script>

